<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F0F6F9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MARK'S TRIP | Tiny Bold</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@400;700;900&family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* --- Tinycottons Bold Palette --- */
            --tc-green: #006B48;    /* 主色：松林綠 */
            --tc-blue: #7EA8BE;     /* 輔助：霧霾藍 */
            --tc-brown: #A66336;    /* 重點：焦糖橘 */
            --tc-bg: #F0F6F9;       /* 背景：淺灰藍 */
            --white: #FFFFFF;
            --black: #1A1A1A;
            
            /* Fonts */
            --font-main: 'Lato', 'Noto Sans TC', sans-serif;
            --font-header: 'Cinzel', serif; 

            /* Layout Specs */
            --radius-card: 24px;
            --radius-btn: 50px;
            --border-width: 2.5px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--tc-bg);
            color: var(--tc-green);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: repeating-linear-gradient(
                45deg,
                var(--tc-green),
                var(--tc-green) 20px,
                var(--tc-blue) 20px,
                var(--tc-blue) 40px
            );
            z-index: 50; flex-shrink: 0; padding-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Segment Bar */
        .segment-bar {
            padding-top: calc(15px + var(--safe-top));
            padding-bottom: 15px; padding-left: 15px; padding-right: 15px;
            display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            border-bottom: var(--border-width) solid var(--tc-green);
        }
        .segment-bar::-webkit-scrollbar { display: none; }

        .seg-chip {
            font-family: var(--font-header); color: var(--tc-green); background: var(--white);
            padding: 10px 20px; border-radius: var(--radius-btn); font-size: 0.8rem;
            white-space: nowrap; font-weight: 900; cursor: pointer; transition: all 0.2s;
            border: var(--border-width) solid var(--tc-green); box-shadow: 3px 3px 0 var(--tc-blue);
        }
        .seg-chip.active {
            background: var(--tc-green); color: var(--white); border-color: var(--tc-green);
            box-shadow: 3px 3px 0 var(--tc-brown); transform: translate(-1px, -1px);
        }

        /* Date Bar */
        .date-bar {
            background: var(--tc-bg); padding: 15px; display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none;
        }
        .date-bar::-webkit-scrollbar { display: none; }

        .date-pill {
            min-width: 60px; height: 75px; border-radius: var(--radius-card); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: var(--white); border: var(--border-width) solid var(--tc-blue); 
            color: var(--tc-blue); cursor: pointer; transition: all 0.2s;
        }
        .date-pill.active {
            background: var(--tc-blue); color: var(--white); border-color: var(--tc-blue);
            box-shadow: 4px 4px 0 var(--tc-green); transform: scale(1.05);
        }
        .dp-day { font-family: var(--font-header); font-size: 0.75rem; text-transform: uppercase; font-weight: 900; }
        .dp-date { font-family: var(--font-header); font-size: 1.3rem; font-weight: 900; }

        /* --- Main Content --- */
        #main-container {
            flex: 1; overflow-y: auto; scroll-behavior: smooth;
            padding: 10px 20px 120px 20px;
        }

        /* --- HOME PAGE STYLES (NEW SQUARE) --- */
        .home-title {
            font-family: var(--font-header); font-weight: 900; font-size: 2.2rem;
            text-align: center; color: var(--tc-green); margin: 30px 0 25px 0;
            line-height: 1.1; letter-spacing: 1px; text-shadow: 2px 2px 0 var(--white);
        }
        .home-boxes-container {
            display: flex; flex-direction: column; align-items: center; gap: 30px;
        }
        .home-card-box {
            width: 85%; max-width: 320px; aspect-ratio: 1 / 1; /* 正方形 */
            border-radius: 35px; /* 大圓角方塊 */
            background: var(--white);
            border: 3px solid var(--tc-green);
            box-shadow: 8px 8px 0 var(--tc-blue); /* 復古硬陰影 */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            transition: transform 0.2s;
        }
        .home-card-box:active { transform: scale(0.98); }
        
        .img-box img {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        .count-box {
            background: var(--tc-green); border-color: var(--tc-brown);
            color: var(--white); flex-direction: column; text-align: center;
            box-shadow: 8px 8px 0 var(--tc-brown);
        }
        .countdown-number {
            font-family: var(--font-header); font-size: 5rem; font-weight: 900; line-height: 1;
        }
        .countdown-label {
            font-family: var(--font-main); font-size: 1.2rem; font-weight: 700; letter-spacing: 2px; margin-top: 5px;
        }
        .countdown-target {
            font-size: 0.9rem; opacity: 0.8; margin-top: 10px; font-family: var(--font-header);
            border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; width: 80%;
        }

        /* Day Hero */
        .day-hero { 
            background: var(--white); padding: 25px; border-radius: var(--radius-card);
            display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; 
            border: var(--border-width) solid var(--tc-green); box-shadow: 6px 6px 0 var(--tc-green);
        }
        .day-info h2 { margin: 0; font-family: var(--font-header); font-size: 1.6rem; color: var(--tc-green); line-height: 1.1; font-weight: 900;}
        .day-info p { margin: 6px 0 0 0; color: var(--tc-brown); font-size: 0.9rem; font-weight: 700; font-family: var(--font-header); letter-spacing: 1px;}
        
        .weather-btn {
            background: var(--tc-blue); color: var(--white); padding: 10px 16px; border: none; text-decoration: none; border-radius: var(--radius-btn);
            font-family: var(--font-header); font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; 
            box-shadow: 2px 2px 0 var(--tc-green);
        }

        /* Cards */
        .card {
            background: var(--white); border-radius: var(--radius-card); padding: 22px; margin-bottom: 20px;
            position: relative; border: var(--border-width) solid var(--tc-green);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
        }
        
        .card-tag {
            position: absolute; top: -12px; left: 20px;
            background: var(--tc-green); color: var(--white);
            font-family: var(--font-header); font-size: 0.75rem; padding: 6px 14px; border-radius: var(--radius-btn);
            text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
            border: 2px solid var(--white);
        }
        .card.type-transport .card-tag { background: var(--tc-brown); }
        .card.type-spot .card-tag { background: var(--tc-blue); }

        .card-header { display: flex; flex-direction: column; align-items: flex-start; margin-top: 5px;}
        .time-badge {
            font-family: var(--font-header); font-size: 1.2rem; font-weight: 900; color: var(--tc-green);
            background: #E8F5E9; padding: 4px 12px; border-radius: var(--radius-btn); display: inline-block; margin-bottom: 8px;
        }
        .card-title { font-family: var(--font-header); font-size: 1.15rem; font-weight: 700; margin-bottom: 6px; color: var(--black); padding-right: 60px; }
        .card-desc { font-size: 1rem; color: #555; line-height: 1.5; font-weight: 500; }

        .card-meta-row {
            display: flex; gap: 15px; margin-top: 12px; padding-top: 12px; border-top: 2px dashed #DDD;
        }
        .meta-item {
            display: flex; align-items: center; gap: 6px; 
            font-family: var(--font-main); font-size: 0.9rem; color: var(--tc-green); font-weight: 700;
        }
        .meta-item i { color: var(--tc-brown); font-size: 1rem;}

        .details-box { display: none; margin-top: 15px; padding-top: 15px; border-top: var(--border-width) solid var(--tc-bg); animation: fadeIn 0.3s; }
        .details-box.show { display: block; }
        
        .action-buttons { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
        .btn { 
            padding: 10px 20px; border-radius: var(--radius-btn); border: none;
            background: var(--tc-green); color: var(--white);
            font-family: var(--font-header); font-size: 0.8rem; text-decoration: none; font-weight: 700; 
            display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        .btn-map { background: var(--tc-blue); }
        .btn-ticket { background: var(--tc-brown); }
        
        .card-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; }
        .icon-btn { color: #BBB; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #F5F5F5;}
        .icon-btn.delete { color: #E57373; }
        .expand-toggle { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--tc-bg); color: var(--tc-green); cursor: pointer; border-radius: 50%; font-weight: bold;}

        .transport-info { 
            background: #FFF3E0; border-radius: 15px; padding: 12px; margin-top: 12px; 
            font-size: 0.9rem; color: var(--tc-brown); display: flex; align-items: center; gap: 10px; font-weight: 700;
            border: 2px solid #FFE0B2;
        }

        /* Forms */
        .add-item-form { background: var(--white); border-radius: var(--radius-card); padding: 20px; margin-top: 30px; border: var(--border-width) dashed var(--tc-blue); }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-input { 
            flex: 1; padding: 12px 18px; border: 2px solid #EEE; border-radius: var(--radius-btn); background: #FAFAFA;
            font-family: var(--font-main); font-size: 1rem; color: var(--tc-green); font-weight: 600;
        }
        .form-input:focus { outline: none; border-color: var(--tc-green); background: #FFF; }
        .add-btn { 
            width: 100%; background: var(--tc-green); color: var(--white); padding: 15px; border-radius: var(--radius-btn); border: none; 
            font-family: var(--font-header); font-weight: 900; font-size: 1rem; cursor: pointer; letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,107,72,0.3);
        }

        /* Bookings */
        .budget-header {
            background: var(--tc-green); color: var(--white); padding: 30px 20px; text-align: center; margin-bottom: 30px; 
            border-radius: var(--radius-card); border: var(--border-width) solid var(--tc-green);
            box-shadow: 6px 6px 0 var(--tc-brown);
        }
        .budget-header input { 
            color: var(--white); border: none; border-bottom: 2px solid var(--white); 
            font-family: var(--font-header); font-weight: 700; text-align: center; background: transparent; width: 60px;
        }

        .booking-item {
            background: var(--white); padding: 20px; border-radius: var(--radius-card); margin-bottom: 15px; 
            box-shadow: 4px 4px 0 #E0E0E0; border: var(--border-width) solid var(--tc-green); display: flex; flex-direction: column; gap: 12px; 
        }
        .booking-item::after {
            content: ''; position: absolute; top: 20px; left: 0; bottom: 20px; width: 6px; 
            background: var(--tc-green); border-radius: 0 4px 4px 0;
        }
        .booking-item.type-transport::after { background: var(--tc-brown); }
        .booking-item.type-hotel::after { background: var(--tc-blue); }
        .booking-item.checked { opacity: 0.5; background: #F9F9F9; box-shadow: none; border-color: #CCC;}

        .mini-btn {
            background: var(--tc-blue); color: var(--white); padding: 4px 12px; font-size: 0.7rem; text-decoration: none; 
            display: inline-block; margin-left: 8px; border-radius: 20px; font-weight: 700; vertical-align: middle;
        }

        /* Dual Input Row */
        .dual-input-row {
            display: flex; align-items: flex-end; justify-content: space-between; 
            padding-top: 15px; border-top: 2px dashed #EEE; gap: 15px;
        }
        .currency-input-group {
            display: flex; flex-direction: column; align-items: flex-start; flex: 1; 
            background: #F5F9FA; padding: 8px 12px; border-radius: 15px; border: 1px solid #E0E0E0;
        }
        .currency-label {
            font-size: 0.7rem; font-family: var(--font-header); color: #888; font-weight: 900; margin-bottom: 2px; letter-spacing: 0.5px;
        }
        .bk-input {
            width: 100%; border: none; background: transparent; text-align: right; font-weight: 700;
            color: var(--tc-green); font-size: 1.1rem; padding: 2px 0;
        }
        .bk-input:focus { outline: none; }

        /* Checklist Styles (Categorized) */
        .check-category-card {
            background: var(--white); border-radius: var(--radius-card); padding: 0 0 20px 0; margin-bottom: 25px;
            border: var(--border-width) solid var(--tc-green); box-shadow: 6px 6px 0 rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .check-category-header {
            background: var(--tc-green); color: var(--white); padding: 15px 20px;
            font-family: var(--font-header); font-weight: 900; font-size: 1.1rem;
            display: flex; justify-content: space-between; align-items: center; letter-spacing: 1px;
        }
        .check-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; border-bottom: 1px dashed #EEE; transition: all 0.2s;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item.checked span { text-decoration: line-through; color: #BBB; }
        .check-left { display: flex; align-items: center; gap: 15px; flex: 1; cursor: pointer; }
        .check-checkbox {
            width: 24px; height: 24px; border: 2.5px solid var(--tc-green); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s;
        }
        .check-item.checked .check-checkbox { background: var(--tc-green); }
        
        /* Cost */
        .converter-box {
            background: var(--tc-blue); color: var(--white); padding: 25px; margin-bottom: 30px;
            border-radius: var(--radius-card); border: var(--border-width) solid var(--tc-green);
            box-shadow: 6px 6px 0 var(--tc-green);
        }
        .conv-input {
            background: rgba(255,255,255,0.25); border: none; padding: 10px; width: 120px; text-align: right; border-radius: 15px;
            font-family: var(--font-header); font-weight: 700; font-size: 1.4rem; color: var(--white);
        }
        .expense-item {
            background: var(--white); padding: 18px; margin-bottom: 12px; border-radius: var(--radius-card); 
            display:flex; justify-content:space-between; align-items:center; 
            border: 2px solid #EEE; box-shadow: 2px 2px 0 #DDD;
        }
        .daily-header {
            color: var(--tc-blue); font-family: var(--font-header); font-weight: 700; font-size: 0.9rem;
            margin: 25px 0 10px 5px; letter-spacing: 1px;
            background: #EBF3F7; display: inline-block; padding: 5px 15px; border-radius: 20px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            border-top: var(--border-width) solid var(--tc-green); display: flex; justify-content: space-around; 
            padding: 15px 0 calc(15px + var(--safe-bottom)) 0; z-index: 100;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; color: #9FB3C0; font-size: 0.7rem; cursor: pointer; padding: 5px; flex: 1; 
            transition: all 0.2s;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 6px; }
        .nav-item span { font-family: var(--font-header); font-weight: 700; letter-spacing: 0.5px;}
        .nav-item.active { color: var(--tc-green); transform: translateY(-5px); }

        .section-view { display: none; padding-bottom: 20px; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

<!-- Header -->
<header id="app-header" style="display:none;">
    <div class="segment-bar" id="segment-bar"></div>
    <div class="date-bar" id="date-bar"></div>
</header>

<div id="main-container">
    
    <!-- VIEW 0: HOME -->
    <div id="view-home" class="section-view active">
        <h1 class="home-title">TAKE MARC<br>TO EUROPE</h1>
        <div class="home-boxes-container">
            <!-- Box 1: Illustration -->
            <div class="home-card-box img-box">
                <!-- User to replace src -->
                <img src="https://scontent-tpe1-1.xx.fbcdn.net/v/t39.30808-6/612388246_10236305700676525_8274520347842375536_n.jpg?stp=dst-jpg_s960x960_tt6&_nc_cat=103&ccb=1-7&_nc_sid=f727a1&_nc_ohc=njI6wR1jAkEQ7kNvwGovOh1&_nc_oc=AdlXuov5t0ZTjsxrFeKfDm1qKeFC-AjDyPmbcXl_4Ul3RdpXyUeJVOIMnU5lX9pZF1U&_nc_zt=23&_nc_ht=scontent-tpe1-1.xx&_nc_gid=-Sqk3HLMd8G4vlQ0PpaBzQ&oh=00_AfqDbkOGqwWZ8Dji2X0UIEcQ2CSzFesaXiYHVuegawcG9g&oe=69645F91" alt="Marc Illustration">
            </div>
            <!-- Box 2: Countdown -->
            <div class="home-card-box count-box">
                <div class="countdown-number" id="cd-days">0</div>
                <div class="countdown-label">DAYS</div>
                <div class="countdown-target">UNTIL MAY 21, 2026</div>
            </div>
        </div>
    </div>

    <!-- VIEW 1: 行程表 -->
    <div id="view-itinerary" class="section-view">
        <div id="day-content"></div>
        
        <div class="add-item-form">
            <h4 style="margin:0 0 15px 0; font-family:var(--font-header); font-weight:900; color:var(--tc-green);">+ ADD TO PLAN</h4>
            <div class="form-row">
                <input type="text" id="new-time" class="form-input" placeholder="Time (e.g. 10:00)" style="flex:1;">
                <select id="new-type" class="form-input" style="flex:1;">
                    <option value="spot">Spot</option>
                    <option value="food">Food</option>
                    <option value="transport">Transport</option>
                </select>
            </div>
            <div class="form-row">
                <input type="text" id="new-duration" class="form-input" placeholder="Duration (e.g. 2h)" style="flex:1;">
                <input type="text" id="new-cost" class="form-input" placeholder="Cost (e.g. €20)" style="flex:1;">
            </div>
            <div class="form-row"><input type="text" id="new-title" class="form-input" placeholder="Title (地點名稱)"></div>
            <div class="form-row"><input type="text" id="new-desc" class="form-input" placeholder="Note (備註)"></div>
            <div class="form-row"><input type="text" id="new-loc" class="form-input" placeholder="Location (Google Maps)"></div>
            <button class="add-btn" onclick="addItemToDay()">CONFIRM</button>
        </div>
    </div>

    <!-- VIEW 2: 預訂 (Bookings) -->
    <div id="view-bookings" class="section-view">
        <div class="budget-header">
            <div style="opacity:0.9; margin-bottom:5px; font-family:var(--font-header); font-weight:700; letter-spacing:1px; color:var(--white);">TOTAL BUDGET</div>
            <div id="total-budget" style="font-size:2rem; font-weight:700; font-family:var(--font-header); line-height:1.2; color:var(--white);">
                NT$ 0<br><span style="font-size:1.3rem; opacity:0.9;">€ 0.00</span>
            </div>
            
            <div style="margin-top:15px; font-size:0.9rem; border-top:2px solid rgba(255,255,255,0.3); padding-top:10px; color:var(--white); font-weight:bold;">
                RATE: 1 € = <input type="number" id="bk-rate" value="35" class="rate-input" style="width:50px; background:transparent; border:none; border-bottom:1px solid white; color:white; text-align:center; font-weight:bold;" onchange="renderBookings()"> NT$
            </div>
        </div>

        <div id="booking-list"></div>
        
        <div style="margin-top:40px; border-top:3px dashed var(--tc-blue); padding-top:20px;">
            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <select id="new-bk-type" class="form-input" style="flex:1;"><option value="transport">Transport</option><option value="hotel">Hotel</option></select>
                <input type="text" id="new-bk-name" class="form-input" placeholder="Name" style="flex:2;">
            </div>
            <button class="add-btn" onclick="addBooking()">ADD TO LIST</button>
        </div>
    </div>

    <!-- VIEW 3: 記帳 (Cost) -->
    <div id="view-money" class="section-view">
        <h2 style="font-family:var(--font-header); font-weight:900; letter-spacing:1px; margin-top:0; color:var(--tc-green); text-align:center;">DAILY COST</h2>
        
        <!-- Currency Converter -->
        <div class="converter-box">
            <div style="font-family:var(--font-header); text-transform:uppercase; margin-bottom:15px; border-bottom:2px solid rgba(255,255,255,0.3); padding-bottom:5px; display:flex; justify-content:space-between; color:white; font-weight:900;">
                <span style="letter-spacing:1px;">Converter</span>
                <span style="font-size:0.8rem;">Rate: <input type="number" id="conv-rate" value="35" class="rate-input" style="width:40px; background:transparent; border:none; border-bottom:1px solid white; color:white; text-align:center;" onchange="convert('rate')"></span>
            </div>
            <div class="conv-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; color:white;">
                <span style="font-weight:900; font-family:var(--font-header);">EUR €</span>
                <input type="number" id="conv-eur" class="conv-input" placeholder="0" onkeyup="convert('eur')">
            </div>
            <div class="conv-row" style="display:flex; justify-content:space-between; align-items:center; color:white;">
                <span style="font-weight:900; font-family:var(--font-header);">TWD $</span>
                <input type="number" id="conv-twd" class="conv-input" placeholder="0" onkeyup="convert('twd')">
            </div>
        </div>

        <div style="background:var(--white); padding:25px; border:var(--border-width) solid var(--tc-green); border-radius:var(--radius-card); box-shadow:6px 6px 0 var(--tc-blue); margin-bottom:25px; text-align:center;">
            <div style="color:var(--tc-blue); margin-bottom:5px; font-family:var(--font-header); font-weight:900; letter-spacing:1px;">GRAND TOTAL</div>
            <div id="expense-total" style="font-size:2.5rem; font-weight:900; color:var(--tc-green); font-family:var(--font-header);">€0.00</div>
        </div>

        <div style="margin-bottom:20px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="date" id="exp-date" class="form-input" style="flex:1; border-color:var(--tc-blue);">
            </div>
            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <input type="text" id="exp-name" class="form-input" placeholder="ITEM" style="flex:2;">
                <input type="number" id="exp-amt" class="form-input" placeholder="€" style="flex:1;">
            </div>
            <button class="add-btn" onclick="addExpense()">RECORD EXPENSE</button>
        </div>

        <div id="expense-list" style="margin-top:30px;"></div>
    </div>

    <!-- VIEW 4: 行李清單 (Checklist) -->
    <div id="view-checklist" class="section-view">
        <h2 style="font-family:var(--font-header); margin-top:0; color:var(--tc-green); text-align:center; font-weight:900;">PACKING LIST</h2>
        
        <div style="background:var(--white); padding:15px; border-radius:var(--radius-card); margin-bottom:20px; border:2px dashed var(--tc-blue);">
            <div style="display:flex; gap:10px;">
                <select id="new-check-cat" class="form-input" style="flex:1; border-color: #EEE;">
                    <option value="CLOTHING">CLOTHING</option>
                    <option value="BEAUTY & CARE">BEAUTY & CARE</option>
                    <option value="ACCESSORIES">ACCESSORIES</option>
                    <option value="ELECTRONICS">ELECTRONICS</option>
                    <option value="ESSENTIALS">ESSENTIALS</option>
                </select>
                <input type="text" id="new-check-item" class="form-input" placeholder="New Item..." style="flex:2; border-color: #EEE;">
            </div>
            <button class="add-btn" style="margin-top:10px; padding:10px;" onclick="addChecklistItem()">+ ADD ITEM</button>
        </div>

        <div id="checklist-container">
            <!-- Categories will be rendered here -->
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('home', this)"><i class="fas fa-home"></i><span>HOME</span></div>
    <div class="nav-item" onclick="switchView('itinerary', this)"><i class="fas fa-map"></i><span>PLAN</span></div>
    <div class="nav-item" onclick="switchView('bookings', this)"><i class="fas fa-ticket-alt"></i><span>BOOKING</span></div>
    <div class="nav-item" onclick="switchView('money', this)"><i class="fas fa-coins"></i><span>COST</span></div>
    <div class="nav-item" onclick="switchView('checklist', this)"><i class="fas fa-clipboard-check"></i><span>CHECK</span></div>
</nav>

<script>
    /* ================= 初始資料 ================= */
    const segments = [
        { id: 'tpe', name: 'Taipei', dates: [0] }, 
        { id: 'lr', name: 'La Rochelle', dates: [1, 2, 3] },
        { id: 'bod', name: 'Bordeaux', dates: [4] },
        { id: 'ksl', name: 'Kœstlach', dates: [5, 6, 7, 8] },
        { id: 'par', name: 'Paris', dates: [9, 10, 11, 12, 13] }
    ];

    const defaultItinerary = [
        { date: "5/21", day: "Wed", city: "Taipei", items: [
            { time: "23:30", type: "transport", title: "Taipei to Paris", desc: "EVA AIR BR87", details: "提前3小時到機場。", link: "https://www.evaair.com/zh-tw/index.html", linkText: "EVA AIR", location: "Taoyuan International Airport", duration: "13h 15m", cost: "Booked" }
        ]},
        { date: "5/22", day: "Thu", city: "La Rochelle", items: [
            { time: "07:45", type: "transport", title: "Arrival in Paris", desc: "Airport Transfer", location: "Charles de Gaulle Airport", duration: "2h", cost: "€15" },
            { time: "PM", type: "transport", title: "To La Rochelle", desc: "SNCF Train", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location: "Gare de La Rochelle", duration: "3h", cost: "Booked" }
        ]},
        { date: "5/23", day: "Fri", city: "La Rochelle", items: [{time:"Day", type:"spot", title:"La Rochelle Port", desc:"Vieux Port, Aquarium", location:"Vieux Port La Rochelle", duration:"4h", cost:"€20"}] },
        { date: "5/24", day: "Sat", city: "La Rochelle", items: [{time:"Day", type:"spot", title:"Local Market", desc:"Enjoy French Life", location:"Marché de La Rochelle", duration:"2h", cost:"€30"}] },
        { date: "5/25", day: "Sun", city: "Bordeaux", items: [
            { time: "AM", type: "transport", title: "To Bordeaux", desc: "SNCF Train", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location:"Gare de Bordeaux-Saint-Jean", duration:"2.5h", cost:"Booked" },
            { time: "PM", type: "spot", title: "Dune du Pilat", desc: "Sand Dune", location:"Dune du Pilat", duration:"3h", cost:"€0" },
            { time: "Eve", type: "spot", title: "City Dinner", desc: "Grand Théâtre", location:"Grand Théâtre de Bordeaux", duration:"2h", cost:"€40" }
        ]},
        { date: "5/26", day: "Mon", city: "Basel", items: [
            { time: "AM", type: "spot", title: "Bordeaux Morning", desc: "Breakfast", location:"Bordeaux", duration:"1h", cost:"€15" },
            { time: "PM", type: "transport", title: "Fly to Basel", desc: "EasyJet (BOD->BSL)", link: "https://www.easyjet.com/en", linkText: "EasyJet", location: "EuroAirport Basel-Mulhouse-Freiburg", duration:"1.5h", cost:"Booked" },
            { time: "Eve", type: "spot", title: "Arrive Kœstlach", desc: "Chang-Yu's Home", location:"10 Rue du Chalet, 68480 Kœstlach", duration:"-", cost:"-" }
        ]},
        { date: "5/27", day: "Tue", city: "Koestlach", items: [{time:"Day", type:"spot", title:"Countryside", desc:"Three Borders", location:"10 Rue du Chalet, 68480 Kœstlach", duration:"Day", cost:"€20"}] },
        { date: "5/28", day: "Wed", city: "Basel", items: [{time:"Day", type:"spot", title:"Basel City", desc:"Museum, Rhine River", location:"Kunstmuseum Basel", duration:"Day", cost:"€30"}] },
        { date: "5/29", day: "Thu", city: "Colmar", items: [{time:"Day", type:"spot", title:"Colmar & Alsace", desc:"Fairytale Town", location:"Colmar", duration:"Day", cost:"€40"}] },
        { date: "5/30", day: "Fri", city: "Paris", items: [
            { time: "AM", type: "transport", title: "To Paris", desc: "TGV Lyria", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location: "Gare de Lyon", duration:"3h", cost:"Booked" },
            { time: "PM", type: "spot", title: "Eiffel Tower", desc: "Seine River", location:"Eiffel Tower", duration:"2h", cost:"€25" }
        ]},
        { date: "5/31", day: "Sat", city: "Paris", items: [{time:"Day", type:"spot", title:"Louvre Museum", desc:"Art & History", location:"Louvre Museum", duration:"4h", cost:"€17"}] },
        { date: "6/1", day: "Sun", city: "Paris", items: [{time:"Day", type:"spot", title:"Le Marais", desc:"Shopping", location:"Le Marais", duration:"4h", cost:"€50"}] },
        { date: "6/2", day: "Mon", city: "Paris", items: [{time:"Day", type:"spot", title:"Montmartre", desc:"Sacré-Cœur", location:"Sacré-Cœur", duration:"3h", cost:"€0"}] },
        { date: "6/3", day: "Tue", city: "Taipei", items: [
            { time: "PM", type: "spot", title: "Last Shopping", desc: "Tax Refund", location:"Paris", duration:"2h", cost:"-" },
            { time: "23:30", type: "transport", title: "Back to Taipei", desc: "EVA AIR BR88", location: "Charles de Gaulle Airport", duration:"13h", cost:"Booked" }
        ]}
    ];

    const defaultBookings = [
        { type: 'transport', name: 'Flight Taipei-Paris', note: 'EVA AIR (Round Trip)', price: 42000, checked: false, link:'https://www.evaair.com/zh-tw/index.html' },
        { type: 'transport', name: 'Train to La Rochelle', note: 'SNCF (TGV)', price: 2500, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'transport', name: 'Train to Bordeaux', note: 'SNCF (Intercités)', price: 1200, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'hotel',     name: 'Bordeaux Hotel', note: 'Booking.com (1 Night)', price: 4500, checked: false, link:'https://www.booking.com' },
        { type: 'transport', name: 'Flight to Basel', note: 'EasyJet (+Luggage)', price: 2800, checked: false, link:'https://www.easyjet.com/en' },
        { type: 'transport', name: 'Train to Paris', note: 'SNCF (TGV Lyria)', price: 3800, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'hotel',     name: 'Paris Hotel', note: 'Booking.com (4 Nights)', price: 28000, checked: false, link:'https://www.booking.com' }
    ];

    // Customized Checklist Data
    const defaultChecklist = [
        { cat: "CLOTHING", items: [
            { name: "睡衣", checked: false }, { name: "內衣褲", checked: false }, { name: "襪子", checked: false }, { name: "幾套穿搭", checked: false }
        ]},
        { cat: "BEAUTY & CARE", items: [
            { name: "化妝包", checked: false }, { name: "眼罩", checked: false }, { name: "髮基因", checked: false }, { name: "隱形眼鏡", checked: false },
            { name: "眼鏡", checked: false }, { name: "身體乳超大罐", checked: false }, { name: "面膜", checked: false }, { name: "香水", checked: false },
            { name: "按摩刮痧", checked: false }, { name: "護手霜", checked: false }, { name: "電棒燙", checked: false }, { name: "橡皮筋", checked: false },
            { name: "保養品包", checked: false }, { name: "防曬", checked: false }, { name: "衛生棉", checked: false }
        ]},
        { cat: "ACCESSORIES", items: [
            { name: "配件", checked: false }, { name: "墨鏡", checked: false }, { name: "戒指/項鍊", checked: false }, { name: "側背包", checked: false }, { name: "Baggu", checked: false }
        ]},
        { cat: "ELECTRONICS", items: [
            { name: "手機充電器", checked: false }, { name: "行充", checked: false }, { name: "變壓器", checked: false }, { name: "耳機充電", checked: false }
        ]},
        { cat: "ESSENTIALS", items: [
            { name: "護照", checked: false }, { name: "藥(維他命、益生菌)", checked: false }, { name: "護墊/衛生棉/安全褲/棉條", checked: false }, 
            { name: "口罩", checked: false }, { name: "esim", checked: false }, { name: "叫車", checked: false }, { name: "帶牙套", checked: false }, 
            { name: "牙刷組、牙膏", checked: false }
        ]}
    ];

    let currentItinerary = [];
    let currentDayIndex = 0;

    /* ================= 系統邏輯 ================= */
    
    function init() {
        // Init Itinerary (v9 to force checklist update)
        const storedItin = localStorage.getItem('mark_trip_itinerary_v9');
        if (storedItin) {
            currentItinerary = JSON.parse(storedItin);
        } else {
            currentItinerary = defaultItinerary;
            localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        }
        
        document.getElementById('exp-date').valueAsDate = new Date();

        renderSegmentBar();
        selectSegment(0); 
        renderBookings();
        renderExpenses();
        renderChecklist();
        switchView('home', document.querySelector('.nav-item.active')); // Default to Home
        
        // Start Countdown
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    // Countdown Logic
    function updateCountdown() {
        const targetDate = new Date("2026-05-21T00:00:00").getTime();
        const now = new Date().getTime();
        const distance = targetDate - now;
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const el = document.getElementById("cd-days");
        if(el) el.innerText = days > 0 ? days : 0;
    }

    /* --- 行程表渲染 --- */
    function renderSegmentBar() {
        const bar = document.getElementById('segment-bar');
        bar.innerHTML = '';
        segments.forEach((seg, idx) => {
            const chip = document.createElement('div');
            chip.className = `seg-chip ${idx === 0 ? 'active' : ''}`;
            chip.innerText = seg.name;
            chip.onclick = () => selectSegment(idx);
            bar.appendChild(chip);
        });
    }
    function selectSegment(segIdx) {
        document.querySelectorAll('.seg-chip').forEach((el, i) => el.classList.toggle('active', i === segIdx));
        renderDateBar(segIdx);
        switchDay(segments[segIdx].dates[0]);
    }
    function renderDateBar(segIdx) {
        const bar = document.getElementById('date-bar');
        bar.innerHTML = '';
        const dayIndices = segments[segIdx].dates;
        dayIndices.forEach((dayIdx) => {
            const d = currentItinerary[dayIdx];
            const pill = document.createElement('div');
            pill.className = `date-pill ${dayIdx === currentDayIndex ? 'active' : ''}`;
            pill.id = `date-pill-${dayIdx}`;
            pill.onclick = () => switchDay(dayIdx);
            pill.innerHTML = `<div class="dp-day">${d.day}</div><div class="dp-date">${d.date}</div>`;
            bar.appendChild(pill);
        });
    }
    function switchDay(idx) {
        currentDayIndex = idx;
        document.querySelectorAll('.date-pill').forEach(el => el.classList.remove('active'));
        const activePill = document.getElementById(`date-pill-${idx}`);
        if(activePill) {
            activePill.classList.add('active');
            activePill.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
        renderDay(idx);
    }
    function renderDay(idx) {
        const data = currentItinerary[idx];
        const container = document.getElementById('day-content');
        const weatherUrl = `https://www.google.com/search?q=weather+${data.city}`;
        let segName = "";
        segments.forEach(s => { if(s.dates.includes(idx)) segName = s.name; });
        let html = `
            <div class="day-hero">
                <div class="day-info"><h2>${data.city}</h2><p> ${segName}</p></div>
                <a href="${weatherUrl}" target="_blank" class="weather-btn"><i class="fas fa-sun"></i> Weather</a>
            </div>`;
        data.items.forEach((item, itemIdx) => {
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location || item.title)}`;
            let btnHtml = `<a href="${mapUrl}" target="_blank" class="btn btn-map"><i class="fas fa-map-marker-alt"></i> MAP</a>`;
            if (item.link) btnHtml += `<a href="${item.link}" target="_blank" class="btn btn-ticket"><i class="fas fa-ticket-alt"></i> ${item.linkText}</a>`;
            
            // Meta Row Logic
            let metaHtml = '';
            if (item.duration || item.cost) {
                metaHtml = `<div class="card-meta-row">`;
                if(item.duration) metaHtml += `<div class="meta-item"><i class="fas fa-clock"></i> ${item.duration}</div>`;
                if(item.cost) metaHtml += `<div class="meta-item"><i class="fas fa-coins"></i> ${item.cost}</div>`;
                metaHtml += `</div>`;
            }

            html += `
                <div class="card type-${item.type}">
                    <div class="card-tag">${item.type}</div>
                    <div class="card-controls">
                        <div class="expand-toggle" onclick="toggleDetails(this)"><i class="fas fa-plus"></i></div>
                        <div class="icon-btn delete" onclick="deleteItemFromDay(${idx}, ${itemIdx})"><i class="fas fa-trash"></i></div>
                    </div>
                    <div class="card-header">
                        <div>
                            <div class="time-badge">${item.time}</div>
                            <div class="card-title">${item.title}</div>
                            <div class="card-desc">${item.desc}</div>
                        </div>
                    </div>
                    ${(item.type==='transport' && item.details) ? `<div class="transport-info"><i class="fas fa-info-circle"></i> ${item.details}</div>` : ''}
                    
                    ${metaHtml}

                    <div class="details-box">
                        ${(item.details && item.type!=='transport') ? `<p style="color:#5D4037; margin-bottom:10px;">${item.details}</p>` : ''}
                        <div class="action-buttons">${btnHtml}</div>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }
    function toggleDetails(btn) {
        const box = btn.closest('.card').querySelector('.details-box');
        const icon = btn.querySelector('.expand-toggle i');
        if (box.classList.contains('show')) { box.classList.remove('show'); icon.className = 'fas fa-plus'; }
        else { box.classList.add('show'); icon.className = 'fas fa-minus'; }
    }
    function addItemToDay() {
        const time = document.getElementById('new-time').value || "TBD";
        const type = document.getElementById('new-type').value;
        const title = document.getElementById('new-title').value;
        const desc = document.getElementById('new-desc').value || "";
        const loc = document.getElementById('new-loc').value || title;
        const dur = document.getElementById('new-duration').value || "";
        const cst = document.getElementById('new-cost').value || "";

        if (!title) { alert("Please enter a title"); return; }
        currentItinerary[currentDayIndex].items.push({time, type, title, desc, location: loc, details: "", duration: dur, cost: cst});
        localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        
        document.getElementById('new-title').value = ""; 
        document.getElementById('new-desc').value = ""; 
        document.getElementById('new-loc').value = "";
        document.getElementById('new-duration').value = "";
        document.getElementById('new-cost').value = "";
        
        renderDay(currentDayIndex);
    }
    function deleteItemFromDay(dayIdx, itemIdx) {
        if (!confirm("Delete?")) return;
        currentItinerary[dayIdx].items.splice(itemIdx, 1);
        localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        renderDay(dayIdx);
    }

    /* --- Bookings Logic --- */
    function getBookings() { return localStorage.getItem('mark_trip_bookings_v9') ? JSON.parse(localStorage.getItem('mark_trip_bookings_v9')) : defaultBookings; }
    function saveBookings(data) { localStorage.setItem('mark_trip_bookings_v9', JSON.stringify(data)); renderBookings(); }
    
    function handleBookingInput(idx, type, val) {
        const list = getBookings();
        const rate = parseFloat(document.getElementById('bk-rate').value) || 35;
        let twdVal;
        if (type === 'eur') {
            twdVal = Math.round(val * rate);
        } else {
            twdVal = parseInt(val) || 0;
        }
        list[idx].price = twdVal; 
        saveBookings(list);
    }

    function renderBookings() {
        const list = getBookings();
        const container = document.getElementById('booking-list');
        container.innerHTML = '';
        let totalTwd = 0;
        const rate = parseFloat(document.getElementById('bk-rate').value) || 35;

        list.forEach((item, idx) => {
            totalTwd += parseInt(item.price || 0); 
            let eurVal = (item.price / rate).toFixed(2);
            let btnHtml = item.link ? `<a href="${item.link}" target="_blank" class="mini-btn">LINK <i class="fas fa-external-link-alt"></i></a>` : '';
            
            container.innerHTML += `
                <div class="booking-item type-${item.type} ${item.checked ? 'checked' : ''}">
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        <input type="checkbox" style="width:20px; height:20px; margin-top:3px; accent-color:#1E5638;" ${item.checked ? 'checked' : ''} onchange="toggleBooking(${idx})">
                        <div style="flex:1;">
                            <div style="font-family:var(--font-header); font-size:0.7rem; color:#888; text-transform:uppercase;">${item.type} ${btnHtml}</div>
                            <div style="font-weight:700; color:#1E5638; font-family:var(--font-main);">${item.name}</div>
                            <div style="font-size:0.85rem; color:#6D7248; margin-top:2px;">${item.note}</div>
                        </div>
                    </div>
                    <div class="dual-input-row">
                        <div class="currency-input-group">
                            <span class="currency-label">EUR €</span>
                            <input type="number" id="eur-input-${idx}" class="bk-input" value="${eurVal}" oninput="handleBookingInput(${idx}, 'eur', this.value)" placeholder="0">
                        </div>
                        <div style="color:#D7CCC8;">↔</div>
                        <div class="currency-input-group">
                            <span class="currency-label">NT$</span>
                            <input type="number" id="twd-input-${idx}" class="bk-input" value="${item.price}" oninput="handleBookingInput(${idx}, 'twd', this.value)" placeholder="0">
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:5px;">
                        <i class="fas fa-trash" style="color:#DDD; cursor:pointer;" onclick="delBooking(${idx})"></i>
                    </div>
                </div>`;
        });
        let totalEur = (totalTwd / rate).toFixed(2);
        document.getElementById('total-budget').innerHTML = `NT$ ${totalTwd.toLocaleString()}<br><span style="font-size:1.5rem; opacity:0.8; font-family:var(--font-header); font-style:italic;">€ ${totalEur}</span>`;
    }
    function toggleBooking(idx) { let l = getBookings(); l[idx].checked = !l[idx].checked; saveBookings(l); }
    function addBooking() {
        const type = document.getElementById('new-bk-type').value;
        const name = document.getElementById('new-bk-name').value;
        if(!name) return;
        let l = getBookings(); l.push({ type, name, note: 'Added', price: 0, checked: false });
        document.getElementById('new-bk-name').value = ''; saveBookings(l);
    }
    function delBooking(idx) { if(confirm('Remove?')) { let l = getBookings(); l.splice(idx, 1); saveBookings(l); } }

    /* --- Money --- */
    function convert(source) {
        const eurInput = document.getElementById('conv-eur');
        const twdInput = document.getElementById('conv-twd');
        const rate = parseFloat(document.getElementById('conv-rate').value) || 35;
        if (source === 'eur') { twdInput.value = Math.round(eurInput.value * rate); } 
        else if (source === 'twd') { eurInput.value = (twdInput.value / rate).toFixed(2); } 
        else if (source === 'rate') { if(eurInput.value) twdInput.value = Math.round(eurInput.value * rate); }
    }

    function renderExpenses() {
        let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')) || [];
        const list = document.getElementById('expense-list');
        list.innerHTML = '';
        let total = 0;
        
        exps.sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));
        const grouped = exps.reduce((acc, curr) => {
            const d = curr.date || 'Undated';
            if(!acc[d]) acc[d] = { total: 0, items: [] };
            acc[d].items.push(curr);
            acc[d].total += parseFloat(curr.amount);
            return acc;
        }, {});

        Object.keys(grouped).forEach(date => {
            const group = grouped[date];
            const div = document.createElement('div');
            div.className = 'daily-group';
            div.innerHTML = `<div class="daily-header"><span>${date}</span><span>Daily: €${group.total.toFixed(2)}</span></div>`;
            group.items.forEach(e => {
                total += parseFloat(e.amount);
                const origIdx = exps.indexOf(e);
                div.innerHTML += `
                    <div class="expense-item">
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-family:var(--font-main); font-weight:700;">${e.name}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-weight:700; color:#1E5638;">€${e.amount}</span>
                            <i class="fas fa-trash" style="color:#DDD; cursor:pointer;" onclick="delExpense(${origIdx})"></i>
                        </div>
                    </div>`;
            });
            list.appendChild(div);
        });
        document.getElementById('expense-total').innerText = '€' + total.toFixed(2);
    }
    function addExpense() {
        const date = document.getElementById('exp-date').value;
        const name = document.getElementById('exp-name').value;
        const amt = document.getElementById('exp-amt').value;
        if(!name || !amt) return;
        let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')) || [];
        const finalDate = date || new Date().toISOString().split('T')[0];
        exps.push({ date: finalDate, name: name, amount: amt });
        localStorage.setItem('mark_trip_expenses_v9', JSON.stringify(exps));
        document.getElementById('exp-name').value = ''; document.getElementById('exp-amt').value = ''; renderExpenses();
    }
    function delExpense(i) { if(confirm('Remove?')) { let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')); exps.splice(i, 1); localStorage.setItem('mark_trip_expenses_v9', JSON.stringify(exps)); renderExpenses(); } }

    /* --- Checklist Logic --- */
    function getChecklist() { return localStorage.getItem('mark_trip_checklist_v9') ? JSON.parse(localStorage.getItem('mark_trip_checklist_v9')) : defaultChecklist; }
    function saveChecklist(data) { localStorage.setItem('mark_trip_checklist_v9', JSON.stringify(data)); renderChecklist(); }

    function renderChecklist() {
        const list = getChecklist();
        const container = document.getElementById('checklist-container');
        container.innerHTML = '';
        list.forEach((catGroup, catIdx) => {
            let itemsHtml = '';
            catGroup.items.forEach((item, itemIdx) => {
                itemsHtml += `
                    <div class="check-item ${item.checked ? 'checked' : ''}" onclick="toggleCheck(${catIdx}, ${itemIdx})">
                        <div class="check-left">
                            <div class="custom-checkbox"><i class="fas fa-check" style="display:${item.checked?'block':'none'}"></i></div>
                            <span>${item.name}</span>
                        </div>
                        <i class="fas fa-trash" style="color:#DDD; padding:5px;" onclick="delCheckItem(event, ${catIdx}, ${itemIdx})"></i>
                    </div>
                `;
            });
            container.innerHTML += `
                <div class="check-category-card">
                    <div class="check-category-header">${catGroup.cat}</div>
                    ${itemsHtml}
                </div>
            `;
        });
    }
    function toggleCheck(catIdx, itemIdx) { 
        let l = getChecklist(); 
        l[catIdx].items[itemIdx].checked = !l[catIdx].items[itemIdx].checked; 
        saveChecklist(l); 
    }
    function addChecklistItem() {
        const cat = document.getElementById('new-check-cat').value;
        const val = document.getElementById('new-check-item').value;
        if(!val) return;
        let l = getChecklist(); 
        let targetCat = l.find(c => c.cat === cat);
        if(targetCat) {
            targetCat.items.push({ name: val, checked: false });
            saveChecklist(l);
            document.getElementById('new-check-item').value = '';
        }
    }
    function delCheckItem(e, catIdx, itemIdx) { 
        e.stopPropagation(); 
        if(confirm('Remove?')) { 
            let l = getChecklist(); 
            l[catIdx].items.splice(itemIdx, 1); 
            saveChecklist(l); 
        } 
    }

    function switchView(id, btn) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        // Hide Header on home page
        document.getElementById('app-header').style.display = (id === 'home') ? 'none' : 'block';
    }

    window.onload = init;
</script>
</body>
</html>

    <!-- VIEW 1: 行程表 -->
    <div id="view-itinerary" class="section-view">
        <div id="day-content"></div>
        
        <div class="add-item-form">
            <h4 style="margin:0 0 15px 0; font-family:var(--font-header); font-weight:900; color:var(--tc-green);">+ ADD TO PLAN</h4>
            <div class="form-row">
                <input type="text" id="new-time" class="form-input" placeholder="Time (e.g. 10:00)" style="flex:1;">
                <select id="new-type" class="form-input" style="flex:1;">
                    <option value="spot">Spot</option>
                    <option value="food">Food</option>
                    <option value="transport">Transport</option>
                </select>
            </div>
            <div class="form-row">
                <input type="text" id="new-duration" class="form-input" placeholder="Duration (e.g. 2h)" style="flex:1;">
                <input type="text" id="new-cost" class="form-input" placeholder="Cost (e.g. €20)" style="flex:1;">
            </div>
            <div class="form-row"><input type="text" id="new-title" class="form-input" placeholder="Title (地點名稱)"></div>
            <div class="form-row"><input type="text" id="new-desc" class="form-input" placeholder="Note (備註)"></div>
            <div class="form-row"><input type="text" id="new-loc" class="form-input" placeholder="Location (Google Maps)"></div>
            <button class="add-btn" onclick="addItemToDay()">CONFIRM</button>
        </div>
    </div>

    <!-- VIEW 2: 預訂 (Bookings) -->
    <div id="view-bookings" class="section-view">
        <div class="budget-header">
            <div style="opacity:0.9; margin-bottom:5px; font-family:var(--font-header); font-weight:700; letter-spacing:1px; color:var(--white);">TOTAL BUDGET</div>
            <div id="total-budget" style="font-size:2rem; font-weight:700; font-family:var(--font-header); line-height:1.2; color:var(--white);">
                NT$ 0<br><span style="font-size:1.3rem; opacity:0.9;">€ 0.00</span>
            </div>
            
            <div style="margin-top:15px; font-size:0.9rem; border-top:2px solid rgba(255,255,255,0.3); padding-top:10px; color:var(--white); font-weight:bold;">
                RATE: 1 € = <input type="number" id="bk-rate" value="35" class="rate-input" style="width:50px; background:transparent; border:none; border-bottom:1px solid white; color:white; text-align:center; font-weight:bold;" onchange="renderBookings()"> NT$
            </div>
        </div>

        <div id="booking-list"></div>
        
        <div style="margin-top:40px; border-top:3px dashed var(--tc-blue); padding-top:20px;">
            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <select id="new-bk-type" class="form-input" style="flex:1;"><option value="transport">Transport</option><option value="hotel">Hotel</option></select>
                <input type="text" id="new-bk-name" class="form-input" placeholder="Name" style="flex:2;">
            </div>
            <button class="add-btn" onclick="addBooking()">ADD TO LIST</button>
        </div>
    </div>

    <!-- VIEW 3: 記帳 (Cost) -->
    <div id="view-money" class="section-view">
        <h2 style="font-family:var(--font-header); font-weight:900; letter-spacing:1px; margin-top:0; color:var(--tc-green); text-align:center;">DAILY COST</h2>
        
        <!-- Currency Converter -->
        <div class="converter-box">
            <div style="font-family:var(--font-header); text-transform:uppercase; margin-bottom:15px; border-bottom:2px solid rgba(255,255,255,0.3); padding-bottom:5px; display:flex; justify-content:space-between; color:white; font-weight:900;">
                <span style="letter-spacing:1px;">Converter</span>
                <span style="font-size:0.8rem;">Rate: <input type="number" id="conv-rate" value="35" class="rate-input" style="width:40px; background:transparent; border:none; border-bottom:1px solid white; color:white; text-align:center;" onchange="convert('rate')"></span>
            </div>
            <div class="conv-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; color:white;">
                <span style="font-weight:900; font-family:var(--font-header);">EUR €</span>
                <input type="number" id="conv-eur" class="conv-input" placeholder="0" onkeyup="convert('eur')">
            </div>
            <div class="conv-row" style="display:flex; justify-content:space-between; align-items:center; color:white;">
                <span style="font-weight:900; font-family:var(--font-header);">TWD $</span>
                <input type="number" id="conv-twd" class="conv-input" placeholder="0" onkeyup="convert('twd')">
            </div>
        </div>

        <div style="background:var(--white); padding:25px; border:var(--border-width) solid var(--tc-green); border-radius:var(--radius-card); box-shadow:6px 6px 0 var(--tc-blue); margin-bottom:25px; text-align:center;">
            <div style="color:var(--tc-blue); margin-bottom:5px; font-family:var(--font-header); font-weight:900; letter-spacing:1px;">GRAND TOTAL</div>
            <div id="expense-total" style="font-size:2.5rem; font-weight:900; color:var(--tc-green); font-family:var(--font-header);">€0.00</div>
        </div>

        <div style="margin-bottom:20px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="date" id="exp-date" class="form-input" style="flex:1; border-color:var(--tc-blue);">
            </div>
            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <input type="text" id="exp-name" class="form-input" placeholder="ITEM" style="flex:2;">
                <input type="number" id="exp-amt" class="form-input" placeholder="€" style="flex:1;">
            </div>
            <button class="add-btn" onclick="addExpense()">RECORD EXPENSE</button>
        </div>

        <div id="expense-list" style="margin-top:30px;"></div>
    </div>

    <!-- VIEW 4: 行李清單 (Checklist) -->
    <div id="view-checklist" class="section-view">
        <h2 style="font-family:var(--font-header); margin-top:0; color:var(--tc-green); text-align:center; font-weight:900;">PACKING LIST</h2>
        
        <div style="background:var(--white); padding:15px; border-radius:var(--radius-card); margin-bottom:20px; border:2px dashed var(--tc-blue);">
            <div style="display:flex; gap:10px;">
                <select id="new-check-cat" class="form-input" style="flex:1; border-color: #EEE;">
                    <option value="CLOTHING">CLOTHING</option>
                    <option value="BEAUTY & CARE">BEAUTY & CARE</option>
                    <option value="ACCESSORIES">ACCESSORIES</option>
                    <option value="ELECTRONICS">ELECTRONICS</option>
                    <option value="ESSENTIALS">ESSENTIALS</option>
                </select>
                <input type="text" id="new-check-item" class="form-input" placeholder="New Item..." style="flex:2; border-color: #EEE;">
            </div>
            <button class="add-btn" style="margin-top:10px; padding:10px;" onclick="addChecklistItem()">+ ADD ITEM</button>
        </div>

        <div id="checklist-container">
            <!-- Categories will be rendered here -->
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('home', this)"><i class="fas fa-home"></i><span>HOME</span></div>
    <div class="nav-item" onclick="switchView('itinerary', this)"><i class="fas fa-map"></i><span>PLAN</span></div>
    <div class="nav-item" onclick="switchView('bookings', this)"><i class="fas fa-ticket-alt"></i><span>BOOK</span></div>
    <div class="nav-item" onclick="switchView('money', this)"><i class="fas fa-coins"></i><span>COST</span></div>
    <div class="nav-item" onclick="switchView('checklist', this)"><i class="fas fa-clipboard-check"></i><span>CHECK</span></div>
</nav>

<script>
    /* ================= 初始資料 ================= */
    const segments = [
        { id: 'tpe', name: 'Taipei', dates: [0] }, 
        { id: 'lr', name: 'La Rochelle', dates: [1, 2, 3] },
        { id: 'bod', name: 'Bordeaux', dates: [4] },
        { id: 'ksl', name: 'Kœstlach', dates: [5, 6, 7, 8] },
        { id: 'par', name: 'Paris', dates: [9, 10, 11, 12, 13] }
    ];

    const defaultItinerary = [
        { date: "5/21", day: "Wed", city: "Taipei", items: [
            { time: "23:30", type: "transport", title: "Taipei to Paris", desc: "EVA AIR BR87", details: "提前3小時到機場。", link: "https://www.evaair.com/zh-tw/index.html", linkText: "EVA AIR", location: "Taoyuan International Airport", duration: "13h 15m", cost: "Booked" }
        ]},
        { date: "5/22", day: "Thu", city: "La Rochelle", items: [
            { time: "07:45", type: "transport", title: "Arrival in Paris", desc: "Airport Transfer", location: "Charles de Gaulle Airport", duration: "2h", cost: "€15" },
            { time: "PM", type: "transport", title: "To La Rochelle", desc: "SNCF Train", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location: "Gare de La Rochelle", duration: "3h", cost: "Booked" }
        ]},
        { date: "5/23", day: "Fri", city: "La Rochelle", items: [{time:"Day", type:"spot", title:"La Rochelle Port", desc:"Vieux Port, Aquarium", location:"Vieux Port La Rochelle", duration:"4h", cost:"€20"}] },
        { date: "5/24", day: "Sat", city: "La Rochelle", items: [{time:"Day", type:"spot", title:"Local Market", desc:"Enjoy French Life", location:"Marché de La Rochelle", duration:"2h", cost:"€30"}] },
        { date: "5/25", day: "Sun", city: "Bordeaux", items: [
            { time: "AM", type: "transport", title: "To Bordeaux", desc: "SNCF Train", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location:"Gare de Bordeaux-Saint-Jean", duration:"2.5h", cost:"Booked" },
            { time: "PM", type: "spot", title: "Dune du Pilat", desc: "Sand Dune", location:"Dune du Pilat", duration:"3h", cost:"€0" },
            { time: "Eve", type: "spot", title: "City Dinner", desc: "Grand Théâtre", location:"Grand Théâtre de Bordeaux", duration:"2h", cost:"€40" }
        ]},
        { date: "5/26", day: "Mon", city: "Basel", items: [
            { time: "AM", type: "spot", title: "Bordeaux Morning", desc: "Breakfast", location:"Bordeaux", duration:"1h", cost:"€15" },
            { time: "PM", type: "transport", title: "Fly to Basel", desc: "EasyJet (BOD->BSL)", link: "https://www.easyjet.com/en", linkText: "EasyJet", location: "EuroAirport Basel-Mulhouse-Freiburg", duration:"1.5h", cost:"Booked" },
            { time: "Eve", type: "spot", title: "Arrive Kœstlach", desc: "Chang-Yu's Home", location:"10 Rue du Chalet, 68480 Kœstlach", duration:"-", cost:"-" }
        ]},
        { date: "5/27", day: "Tue", city: "Koestlach", items: [{time:"Day", type:"spot", title:"Countryside", desc:"Three Borders", location:"10 Rue du Chalet, 68480 Kœstlach", duration:"Day", cost:"€20"}] },
        { date: "5/28", day: "Wed", city: "Basel", items: [{time:"Day", type:"spot", title:"Basel City", desc:"Museum, Rhine River", location:"Kunstmuseum Basel", duration:"Day", cost:"€30"}] },
        { date: "5/29", day: "Thu", city: "Colmar", items: [{time:"Day", type:"spot", title:"Colmar & Alsace", desc:"Fairytale Town", location:"Colmar", duration:"Day", cost:"€40"}] },
        { date: "5/30", day: "Fri", city: "Paris", items: [
            { time: "AM", type: "transport", title: "To Paris", desc: "TGV Lyria", link: "https://www.sncf-connect.com/en-en/", linkText: "SNCF", location: "Gare de Lyon", duration:"3h", cost:"Booked" },
            { time: "PM", type: "spot", title: "Eiffel Tower", desc: "Seine River", location:"Eiffel Tower", duration:"2h", cost:"€25" }
        ]},
        { date: "5/31", day: "Sat", city: "Paris", items: [{time:"Day", type:"spot", title:"Louvre Museum", desc:"Art & History", location:"Louvre Museum", duration:"4h", cost:"€17"}] },
        { date: "6/1", day: "Sun", city: "Paris", items: [{time:"Day", type:"spot", title:"Le Marais", desc:"Shopping", location:"Le Marais", duration:"4h", cost:"€50"}] },
        { date: "6/2", day: "Mon", city: "Paris", items: [{time:"Day", type:"spot", title:"Montmartre", desc:"Sacré-Cœur", location:"Sacré-Cœur", duration:"3h", cost:"€0"}] },
        { date: "6/3", day: "Tue", city: "Taipei", items: [
            { time: "PM", type: "spot", title: "Last Shopping", desc: "Tax Refund", location:"Paris", duration:"2h", cost:"-" },
            { time: "23:30", type: "transport", title: "Back to Taipei", desc: "EVA AIR BR88", location: "Charles de Gaulle Airport", duration:"13h", cost:"Booked" }
        ]}
    ];

    const defaultBookings = [
        { type: 'transport', name: 'Flight Taipei-Paris', note: 'EVA AIR (Round Trip)', price: 42000, checked: false, link:'https://www.evaair.com/zh-tw/index.html' },
        { type: 'transport', name: 'Train to La Rochelle', note: 'SNCF (TGV)', price: 2500, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'transport', name: 'Train to Bordeaux', note: 'SNCF (Intercités)', price: 1200, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'hotel',     name: 'Bordeaux Hotel', note: 'Booking.com (1 Night)', price: 4500, checked: false, link:'https://www.booking.com' },
        { type: 'transport', name: 'Flight to Basel', note: 'EasyJet (+Luggage)', price: 2800, checked: false, link:'https://www.easyjet.com/en' },
        { type: 'transport', name: 'Train to Paris', note: 'SNCF (TGV Lyria)', price: 3800, checked: false, link:'https://www.sncf-connect.com/en-en/' },
        { type: 'hotel',     name: 'Paris Hotel', note: 'Booking.com (4 Nights)', price: 28000, checked: false, link:'https://www.booking.com' }
    ];

    const defaultChecklist = [
        { cat: "CLOTHING", items: [
            { name: "睡衣", checked: false }, { name: "內衣褲", checked: false }, { name: "襪子", checked: false }, { name: "幾套穿搭", checked: false }
        ]},
        { cat: "BEAUTY & CARE", items: [
            { name: "化妝包", checked: false }, { name: "眼罩", checked: false }, { name: "髮基因", checked: false }, { name: "隱形眼鏡", checked: false },
            { name: "眼鏡", checked: false }, { name: "身體乳超大罐", checked: false }, { name: "面膜", checked: false }, { name: "香水", checked: false },
            { name: "按摩刮痧", checked: false }, { name: "護手霜", checked: false }, { name: "電棒燙", checked: false }, { name: "橡皮筋", checked: false },
            { name: "保養品包", checked: false }, { name: "防曬", checked: false }, { name: "衛生棉", checked: false }
        ]},
        { cat: "ACCESSORIES", items: [
            { name: "配件", checked: false }, { name: "墨鏡", checked: false }, { name: "戒指/項鍊", checked: false }, { name: "側背包", checked: false }, { name: "Baggu", checked: false }
        ]},
        { cat: "ELECTRONICS", items: [
            { name: "手機充電器", checked: false }, { name: "行充", checked: false }, { name: "變壓器", checked: false }, { name: "耳機充電", checked: false }
        ]},
        { cat: "ESSENTIALS", items: [
            { name: "護照", checked: false }, { name: "藥(維他命、益生菌)", checked: false }, { name: "護墊/衛生棉/安全褲/棉條", checked: false }, 
            { name: "口罩", checked: false }, { name: "esim", checked: false }, { name: "叫車", checked: false }, { name: "帶牙套", checked: false }, 
            { name: "牙刷組、牙膏", checked: false }
        ]}
    ];

    let currentItinerary = [];
    let currentDayIndex = 0;

    /* ================= 系統邏輯 ================= */
    
    function init() {
        // Init Itinerary (v9 to force checklist update)
        const storedItin = localStorage.getItem('mark_trip_itinerary_v9');
        if (storedItin) {
            currentItinerary = JSON.parse(storedItin);
        } else {
            currentItinerary = defaultItinerary;
            localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        }
        
        document.getElementById('exp-date').valueAsDate = new Date();

        renderSegmentBar();
        selectSegment(0); 
        renderBookings();
        renderExpenses();
        renderChecklist();
        switchView('home', document.querySelector('.nav-item.active')); // Default to Home
        
        // Start Countdown
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    // Countdown Logic
    function updateCountdown() {
        // Target Date: May 21, 2026
        const targetDate = new Date("2026-05-21T00:00:00").getTime();
        const now = new Date().getTime();
        const distance = targetDate - now;

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const el = document.getElementById("cd-days");
        if(el) el.innerText = days > 0 ? days : 0;
    }

    /* --- 行程表渲染 --- */
    function renderSegmentBar() {
        const bar = document.getElementById('segment-bar');
        bar.innerHTML = '';
        segments.forEach((seg, idx) => {
            const chip = document.createElement('div');
            chip.className = `seg-chip ${idx === 0 ? 'active' : ''}`;
            chip.innerText = seg.name;
            chip.onclick = () => selectSegment(idx);
            bar.appendChild(chip);
        });
    }
    function selectSegment(segIdx) {
        document.querySelectorAll('.seg-chip').forEach((el, i) => el.classList.toggle('active', i === segIdx));
        renderDateBar(segIdx);
        switchDay(segments[segIdx].dates[0]);
    }
    function renderDateBar(segIdx) {
        const bar = document.getElementById('date-bar');
        bar.innerHTML = '';
        const dayIndices = segments[segIdx].dates;
        dayIndices.forEach((dayIdx) => {
            const d = currentItinerary[dayIdx];
            const pill = document.createElement('div');
            pill.className = `date-pill ${dayIdx === currentDayIndex ? 'active' : ''}`;
            pill.id = `date-pill-${dayIdx}`;
            pill.onclick = () => switchDay(dayIdx);
            pill.innerHTML = `<div class="dp-day">${d.day}</div><div class="dp-date">${d.date}</div>`;
            bar.appendChild(pill);
        });
    }
    function switchDay(idx) {
        currentDayIndex = idx;
        document.querySelectorAll('.date-pill').forEach(el => el.classList.remove('active'));
        const activePill = document.getElementById(`date-pill-${idx}`);
        if(activePill) {
            activePill.classList.add('active');
            activePill.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
        renderDay(idx);
    }
    function renderDay(idx) {
        const data = currentItinerary[idx];
        const container = document.getElementById('day-content');
        const weatherUrl = `https://www.google.com/search?q=weather+${data.city}`;
        let segName = "";
        segments.forEach(s => { if(s.dates.includes(idx)) segName = s.name; });
        let html = `
            <div class="day-hero">
                <div class="day-info"><h2>${data.city}</h2><p> ${segName}</p></div>
                <a href="${weatherUrl}" target="_blank" class="weather-btn"><i class="fas fa-sun"></i> Weather</a>
            </div>`;
        data.items.forEach((item, itemIdx) => {
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location || item.title)}`;
            let btnHtml = `<a href="${mapUrl}" target="_blank" class="btn btn-map"><i class="fas fa-map-marker-alt"></i> MAP</a>`;
            if (item.link) btnHtml += `<a href="${item.link}" target="_blank" class="btn btn-ticket"><i class="fas fa-ticket-alt"></i> ${item.linkText}</a>`;
            
            // Meta Row Logic
            let metaHtml = '';
            if (item.duration || item.cost) {
                metaHtml = `<div class="card-meta-row">`;
                if(item.duration) metaHtml += `<div class="meta-item"><i class="fas fa-clock"></i> ${item.duration}</div>`;
                if(item.cost) metaHtml += `<div class="meta-item"><i class="fas fa-coins"></i> ${item.cost}</div>`;
                metaHtml += `</div>`;
            }

            html += `
                <div class="card type-${item.type}">
                    <div class="card-tag">${item.type}</div>
                    <div class="card-controls">
                        <div class="expand-toggle" onclick="toggleDetails(this)"><i class="fas fa-plus"></i></div>
                        <div class="icon-btn delete" onclick="deleteItemFromDay(${idx}, ${itemIdx})"><i class="fas fa-trash"></i></div>
                    </div>
                    <div class="card-header">
                        <div>
                            <div class="time-badge">${item.time}</div>
                            <div class="card-title">${item.title}</div>
                            <div class="card-desc">${item.desc}</div>
                        </div>
                    </div>
                    ${(item.type==='transport' && item.details) ? `<div class="transport-info"><i class="fas fa-info-circle"></i> ${item.details}</div>` : ''}
                    
                    ${metaHtml}

                    <div class="details-box">
                        ${(item.details && item.type!=='transport') ? `<p style="color:#5D4037; margin-bottom:10px;">${item.details}</p>` : ''}
                        <div class="action-buttons">${btnHtml}</div>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }
    function toggleDetails(btn) {
        const box = btn.closest('.card').querySelector('.details-box');
        const icon = btn.querySelector('.expand-toggle i');
        if (box.classList.contains('show')) { box.classList.remove('show'); icon.className = 'fas fa-plus'; }
        else { box.classList.add('show'); icon.className = 'fas fa-minus'; }
    }
    function addItemToDay() {
        const time = document.getElementById('new-time').value || "TBD";
        const type = document.getElementById('new-type').value;
        const title = document.getElementById('new-title').value;
        const desc = document.getElementById('new-desc').value || "";
        const loc = document.getElementById('new-loc').value || title;
        const dur = document.getElementById('new-duration').value || "";
        const cst = document.getElementById('new-cost').value || "";

        if (!title) { alert("Please enter a title"); return; }
        currentItinerary[currentDayIndex].items.push({time, type, title, desc, location: loc, details: "", duration: dur, cost: cst});
        localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        
        document.getElementById('new-title').value = ""; 
        document.getElementById('new-desc').value = ""; 
        document.getElementById('new-loc').value = "";
        document.getElementById('new-duration').value = "";
        document.getElementById('new-cost').value = "";
        
        renderDay(currentDayIndex);
    }
    function deleteItemFromDay(dayIdx, itemIdx) {
        if (!confirm("Delete?")) return;
        currentItinerary[dayIdx].items.splice(itemIdx, 1);
        localStorage.setItem('mark_trip_itinerary_v9', JSON.stringify(currentItinerary));
        renderDay(dayIdx);
    }

    /* --- Bookings Logic (Dual Currency) --- */
    function getBookings() { return localStorage.getItem('mark_trip_bookings_v9') ? JSON.parse(localStorage.getItem('mark_trip_bookings_v9')) : defaultBookings; }
    function saveBookings(data) { localStorage.setItem('mark_trip_bookings_v9', JSON.stringify(data)); renderBookings(); }
    
    function handleBookingInput(idx, type, val) {
        const list = getBookings();
        const rate = parseFloat(document.getElementById('bk-rate').value) || 35;
        let twdVal;

        if (type === 'eur') {
            twdVal = Math.round(val * rate);
        } else {
            twdVal = parseInt(val) || 0;
        }
        
        list[idx].price = twdVal; // Always store in TWD base
        saveBookings(list);
    }

    function renderBookings() {
        const list = getBookings();
        const container = document.getElementById('booking-list');
        container.innerHTML = '';
        let totalTwd = 0;
        const rate = parseFloat(document.getElementById('bk-rate').value) || 35;

        list.forEach((item, idx) => {
            totalTwd += parseInt(item.price || 0); 
            // Calculate EUR display value from stored TWD
            let eurVal = (item.price / rate).toFixed(2);
            // Use stored TWD for TWD input, but if it's 0, show empty or 0
            let twdDisplay = item.price;

            let btnHtml = item.link ? `<a href="${item.link}" target="_blank" class="mini-btn">LINK <i class="fas fa-external-link-alt"></i></a>` : '';
            
            container.innerHTML += `
                <div class="booking-item type-${item.type} ${item.checked ? 'checked' : ''}">
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        <input type="checkbox" style="width:20px; height:20px; margin-top:3px; accent-color:#1E5638;" ${item.checked ? 'checked' : ''} onchange="toggleBooking(${idx})">
                        <div style="flex:1;">
                            <div style="font-family:var(--font-header); font-size:0.7rem; color:#888; text-transform:uppercase;">${item.type} ${btnHtml}</div>
                            <div style="font-weight:700; color:#1E5638; font-family:var(--font-main);">${item.name}</div>
                            <div style="font-size:0.85rem; color:#6D7248; margin-top:2px;">${item.note}</div>
                        </div>
                    </div>
                    
                    <div class="dual-input-row">
                        <div class="currency-input-group">
                            <span class="currency-label">EUR €</span>
                            <input type="number" id="eur-input-${idx}" class="bk-input" value="${eurVal}" oninput="handleBookingInput(${idx}, 'eur', this.value)" placeholder="0">
                        </div>
                        <div style="color:#D7CCC8;">↔</div>
                        <div class="currency-input-group">
                            <span class="currency-label">NT$</span>
                            <input type="number" id="twd-input-${idx}" class="bk-input" value="${twdDisplay}" oninput="handleBookingInput(${idx}, 'twd', this.value)" placeholder="0">
                        </div>
                    </div>
                    
                    <div style="text-align:right; margin-top:5px;">
                        <i class="fas fa-trash" style="color:#DDD; cursor:pointer;" onclick="delBooking(${idx})"></i>
                    </div>
                </div>`;
        });
        
        // Update Total Display
        let totalEur = (totalTwd / rate).toFixed(2);
        document.getElementById('total-budget').innerHTML = `NT$ ${totalTwd.toLocaleString()}<br><span style="font-size:1.5rem; opacity:0.8; font-family:var(--font-header); font-style:italic;">€ ${totalEur}</span>`;
    }
    
    function toggleBooking(idx) { let l = getBookings(); l[idx].checked = !l[idx].checked; saveBookings(l); }
    
    function addBooking() {
        const type = document.getElementById('new-bk-type').value;
        const name = document.getElementById('new-bk-name').value;
        if(!name) return;
        let l = getBookings(); l.push({ type, name, note: 'Added', price: 0, checked: false });
        document.getElementById('new-bk-name').value = ''; saveBookings(l);
    }
    function delBooking(idx) { if(confirm('Remove?')) { let l = getBookings(); l.splice(idx, 1); saveBookings(l); } }

    /* --- Money --- */
    function convert(source) {
        const eurInput = document.getElementById('conv-eur');
        const twdInput = document.getElementById('conv-twd');
        const rate = parseFloat(document.getElementById('conv-rate').value) || 35;
        if (source === 'eur') { twdInput.value = Math.round(eurInput.value * rate); } 
        else if (source === 'twd') { eurInput.value = (twdInput.value / rate).toFixed(2); } 
        else if (source === 'rate') { if(eurInput.value) twdInput.value = Math.round(eurInput.value * rate); }
    }

    function renderExpenses() {
        let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')) || [];
        const list = document.getElementById('expense-list');
        list.innerHTML = '';
        let total = 0;
        
        exps.sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));
        const grouped = exps.reduce((acc, curr) => {
            const d = curr.date || 'Undated';
            if(!acc[d]) acc[d] = { total: 0, items: [] };
            acc[d].items.push(curr);
            acc[d].total += parseFloat(curr.amount);
            return acc;
        }, {});

        Object.keys(grouped).forEach(date => {
            const group = grouped[date];
            const div = document.createElement('div');
            div.className = 'daily-group';
            div.innerHTML = `<div class="daily-header"><span>${date}</span><span>Daily: €${group.total.toFixed(2)}</span></div>`;
            
            group.items.forEach(e => {
                total += parseFloat(e.amount);
                const origIdx = exps.indexOf(e);
                div.innerHTML += `
                    <div class="expense-item">
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-family:var(--font-main); font-weight:700;">${e.name}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-weight:700; color:#1E5638;">€${e.amount}</span>
                            <i class="fas fa-trash" style="color:#DDD; cursor:pointer;" onclick="delExpense(${origIdx})"></i>
                        </div>
                    </div>`;
            });
            list.appendChild(div);
        });
        document.getElementById('expense-total').innerText = '€' + total.toFixed(2);
    }
    function addExpense() {
        const date = document.getElementById('exp-date').value;
        const name = document.getElementById('exp-name').value;
        const amt = document.getElementById('exp-amt').value;
        if(!name || !amt) return;
        let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')) || [];
        const finalDate = date || new Date().toISOString().split('T')[0];
        exps.push({ date: finalDate, name: name, amount: amt });
        localStorage.setItem('mark_trip_expenses_v9', JSON.stringify(exps));
        document.getElementById('exp-name').value = ''; document.getElementById('exp-amt').value = ''; renderExpenses();
    }
    function delExpense(i) { if(confirm('Remove?')) { let exps = JSON.parse(localStorage.getItem('mark_trip_expenses_v9')); exps.splice(i, 1); localStorage.setItem('mark_trip_expenses_v9', JSON.stringify(exps)); renderExpenses(); } }

    /* --- Checklist Logic (Categorized) --- */
    function getChecklist() { return localStorage.getItem('mark_trip_checklist_v9') ? JSON.parse(localStorage.getItem('mark_trip_checklist_v9')) : defaultChecklist; }
    function saveChecklist(data) { localStorage.setItem('mark_trip_checklist_v9', JSON.stringify(data)); renderChecklist(); }

    function renderChecklist() {
        const list = getChecklist();
        const container = document.getElementById('checklist-container');
        container.innerHTML = '';
        list.forEach((catGroup, catIdx) => {
            let itemsHtml = '';
            catGroup.items.forEach((item, itemIdx) => {
                itemsHtml += `
                    <div class="check-item ${item.checked ? 'checked' : ''}" onclick="toggleCheck(${catIdx}, ${itemIdx})">
                        <div class="check-left">
                            <div class="custom-checkbox"><i class="fas fa-check" style="display:${item.checked?'block':'none'}"></i></div>
                            <span>${item.name}</span>
                        </div>
                        <i class="fas fa-trash" style="color:#DDD; padding:5px;" onclick="delCheckItem(event, ${catIdx}, ${itemIdx})"></i>
                    </div>
                `;
            });
            container.innerHTML += `
                <div class="check-category-card">
                    <div class="check-category-header">${catGroup.cat}</div>
                    ${itemsHtml}
                </div>
            `;
        });
    }
    function toggleCheck(catIdx, itemIdx) { 
        let l = getChecklist(); 
        l[catIdx].items[itemIdx].checked = !l[catIdx].items[itemIdx].checked; 
        saveChecklist(l); 
    }
    function addChecklistItem() {
        const cat = document.getElementById('new-check-cat').value;
        const val = document.getElementById('new-check-item').value;
        if(!val) return;
        let l = getChecklist(); 
        let targetCat = l.find(c => c.cat === cat);
        if(targetCat) {
            targetCat.items.push({ name: val, checked: false });
            saveChecklist(l);
            document.getElementById('new-check-item').value = '';
        }
    }
    function delCheckItem(e, catIdx, itemIdx) { 
        e.stopPropagation(); 
        if(confirm('Remove?')) { 
            let l = getChecklist(); 
            l[catIdx].items.splice(itemIdx, 1); 
            saveChecklist(l); 
        } 
    }

    function switchView(id, btn) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        // Hide Header on home page
        document.getElementById('app-header').style.display = (id === 'home') ? 'none' : 'block';
    }

    window.onload = init;
</script>
</body>
</html>