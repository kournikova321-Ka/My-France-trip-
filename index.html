
import React, { useState, useEffect } from 'react';
import { INITIAL_ITINERARY } from './constants';
import DayCard from './components/DayCard';
import GeminiChat from './components/GeminiChat';
import { Map, Plane, Compass, Heart, ShieldAlert, Plus, Star, Trash2, CheckCircle2, Circle, LayoutGrid } from 'lucide-react';
import { DayPlan, WishListItem } from './types';

const App: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'plan' | 'guide' | 'wishlist'>('plan');
  const [itinerary, setItinerary] = useState<DayPlan[]>(INITIAL_ITINERARY);
  const [wishList, setWishList] = useState<WishListItem[]>([
    { id: 'w1', text: '在塞納河畔喝咖啡', checked: false },
    { id: 'w2', text: '買到喜歡的 Longchamp 包', checked: false },
    { id: 'w3', text: '吃一次正統法式田螺', checked: false }
  ]);
  const [newWish, setNewWish] = useState('');

  // Itinerary Management
  const deleteDay = (id: string) => {
    setItinerary(itinerary.filter(day => day.id !== id));
  };

  const addDay = () => {
    const newDayNum = itinerary.length + 1;
    const lastDay = itinerary[itinerary.length - 1];
    const newDay: DayPlan = {
      id: Math.random().toString(36).substr(2, 9),
      day: newDayNum,
      date: "待定",
      title: "自定義新行程",
      startTime: "09:00",
      description: "請點擊展開編輯此日行程描述...",
      spots: [],
      transports: [],
      budget: "0 EUR",
      precautions: ["注意安全"],
      checklist: [{ id: Math.random().toString(), text: '準備行李', checked: false }]
    };
    setItinerary([...itinerary, newDay]);
  };

  const toggleDayCheck = (dayId: string, itemId: string) => {
    setItinerary(itinerary.map(day => {
      if (day.id === dayId) {
        return {
          ...day,
          checklist: day.checklist.map(item => 
            item.id === itemId ? { ...item, checked: !item.checked } : item
          )
        };
      }
      return day;
    }));
  };

  // WishList Management
  const addWish = () => {
    if (!newWish.trim()) return;
    setWishList([...wishList, { id: Math.random().toString(), text: newWish, checked: false }]);
    setNewWish('');
  };

  const toggleWish = (id: string) => {
    setWishList(wishList.map(w => w.id === id ? { ...w, checked: !w.checked } : w));
  };

  const deleteWish = (id: string) => {
    setWishList(wishList.filter(w => w.id !== id));
  };

  const completedChecklistCount = itinerary.reduce((acc, day) => 
    acc + day.checklist.filter(c => c.checked).length, 0);
  const totalChecklistCount = itinerary.reduce((acc, day) => acc + day.checklist.length, 0);

  return (
    <div className="max-w-md mx-auto bg-stone-50 min-h-screen pb-24 font-sans antialiased">
      {/* Hero Header */}
      <header className="bg-custom-blue text-white pt-10 pb-20 px-6 relative overflow-hidden">
        <div className="relative z-10">
          <div className="flex items-center gap-2 text-blue-200 text-xs font-bold uppercase tracking-[0.2em] mb-2">
            <Plane className="w-3 h-3" />
            <span>France & Swiss Adventure 2024</span>
          </div>
          <h1 className="text-3xl font-bold leading-tight">法國 14 天<br/>深度旅遊企劃書</h1>
          <p className="mt-2 text-blue-100 text-sm opacity-80">巴黎 • La Rochelle • 波爾多 • 瑞士</p>
        </div>
        <div className="absolute -bottom-20 -right-20 w-64 h-64 bg-custom-brown opacity-20 rounded-full blur-3xl"></div>
      </header>

      {/* Stats Summary */}
      <div className="px-6 -mt-12 relative z-20">
        <div className="bg-white rounded-2xl shadow-xl p-4 flex justify-between items-center border border-stone-100">
          <div className="text-center flex-1 border-r border-stone-100 px-2">
            <p className="text-[10px] text-stone-400 uppercase font-bold">總天數</p>
            <p className="text-lg font-bold text-custom-blue">{itinerary.length} 天</p>
          </div>
          <div className="text-center flex-1 border-r border-stone-100 px-2">
            <p className="text-[10px] text-stone-400 uppercase font-bold">清單進度</p>
            <p className="text-lg font-bold text-custom-brown">
              {completedChecklistCount}/{totalChecklistCount}
            </p>
          </div>
          <div className="text-center flex-1 px-2">
            <p className="text-[10px] text-stone-400 uppercase font-bold">願望達成</p>
            <p className="text-lg font-bold text-green-600">
              {wishList.filter(w => w.checked).length}
            </p>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="mt-8 px-6">
        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
          <button 
            onClick={() => setActiveTab('plan')}
            className={`flex-none px-5 py-3 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'plan' ? 'bg-custom-blue text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}
          >
            <Map className="w-4 h-4" /> 每日行程
          </button>
          <button 
            onClick={() => setActiveTab('wishlist')}
            className={`flex-none px-5 py-3 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'wishlist' ? 'bg-custom-blue text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}
          >
            <Star className="w-4 h-4" /> Wish List
          </button>
          <button 
            onClick={() => setActiveTab('guide')}
            className={`flex-none px-5 py-3 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'guide' ? 'bg-custom-blue text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}`}
          >
            <Compass className="w-4 h-4" /> 攻略
          </button>
        </div>

        {activeTab === 'plan' ? (
          <div className="space-y-4">
            <div className="flex justify-between items-center mb-4 px-1">
              <h2 className="text-lg font-bold text-custom-blue flex items-center gap-2">
                <LayoutGrid className="w-5 h-5" /> 行程總覽
              </h2>
              <button 
                onClick={addDay}
                className="flex items-center gap-1 text-xs font-bold bg-custom-brown text-white py-2 px-4 rounded-full hover:bg-brown-900 transition-colors shadow-sm"
              >
                <Plus className="w-3 h-3" /> 新增行程
              </button>
            </div>
            {itinerary.length > 0 ? (
              itinerary.map((day) => (
                <DayCard 
                  key={day.id} 
                  plan={day} 
                  onDelete={deleteDay} 
                  onToggleCheck={toggleDayCheck}
                />
              ))
            ) : (
              <div className="text-center py-24 bg-white rounded-3xl border border-dashed border-stone-300">
                <Compass className="w-12 h-12 mx-auto text-stone-200 mb-4" />
                <p className="text-stone-400 text-sm">行程空空如也，點擊上方按鈕開始規劃！</p>
              </div>
            )}
          </div>
        ) : activeTab === 'wishlist' ? (
          <div className="space-y-6">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-stone-100">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-yellow-50 rounded-xl">
                  <Star className="w-6 h-6 text-yellow-500 fill-yellow-500" />
                </div>
                <div>
                  <h3 className="text-xl font-bold text-custom-blue">旅遊願望清單</h3>
                  <p className="text-xs text-stone-400">記錄你想在法國與瑞士實現的小事</p>
                </div>
              </div>
              
              <div className="flex gap-2 mb-8">
                <input 
                  type="text" 
                  value={newWish}
                  onChange={(e) => setNewWish(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && addWish()}
                  placeholder="想做的事、想買的東西..."
                  className="flex-1 bg-stone-50 border border-stone-100 rounded-2xl px-5 py-3 text-sm focus:ring-2 focus:ring-custom-blue outline-none transition-all"
                />
                <button 
                  onClick={addWish}
                  className="bg-custom-blue text-white p-3 rounded-2xl shadow-lg active:scale-95 transition-transform"
                >
                  <Plus className="w-6 h-6" />
                </button>
              </div>

              <div className="space-y-4">
                {wishList.map(wish => (
                  <div key={wish.id} className={`flex items-center justify-between group p-4 rounded-2xl border transition-all ${wish.checked ? 'bg-stone-50 border-stone-100' : 'bg-white border-stone-200 shadow-sm'}`}>
                    <div 
                      className="flex items-center gap-4 cursor-pointer flex-1"
                      onClick={() => toggleWish(wish.id)}
                    >
                      {wish.checked ? (
                        <CheckCircle2 className="w-6 h-6 text-green-500" />
                      ) : (
                        <Circle className="w-6 h-6 text-stone-300" />
                      )}
                      <span className={`text-base ${wish.checked ? 'text-stone-400 line-through' : 'text-stone-800 font-medium'}`}>
                        {wish.text}
                      </span>
                    </div>
                    <button 
                      onClick={() => deleteWish(wish.id)}
                      className="text-stone-200 hover:text-red-400 transition-colors p-2"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ) : (
          <div className="space-y-6 pb-10">
            {/* Guide Section */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-stone-100">
              <h3 className="text-lg font-bold text-custom-blue flex items-center gap-2 mb-4">
                <Heart className="w-5 h-5 text-red-400" /> 住宿與安全建議
              </h3>
              <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-2xl border-l-4 border-custom-blue">
                  <p className="text-sm font-bold text-custom-blue mb-1">巴黎 15 區 & 14 區</p>
                  <p className="text-xs text-stone-600 leading-relaxed">
                    預算 6000 台幣左右的首選。安全、住宅氣息重，鄰近蒙帕納斯大樓，交通樞紐。
                  </p>
                </div>
                <div className="bg-orange-50 p-4 rounded-2xl border-l-4 border-custom-brown">
                  <p className="text-sm font-bold text-custom-brown mb-1">瑞士跨國 TGV</p>
                  <p className="text-xs text-stone-600 leading-relaxed">
                    從巴賽爾回巴黎建議選 TGV Lyria，車上風景極佳且有插座與 Wi-Fi。
                  </p>
                </div>
              </div>
            </div>

            <div className="bg-red-50 p-6 rounded-3xl border border-red-100">
              <h3 className="text-lg font-bold text-red-800 flex items-center gap-2 mb-4">
                <ShieldAlert className="w-5 h-5 text-red-600" /> 旅途應急錦囊
              </h3>
              <ul className="text-sm text-red-900 space-y-3 list-disc list-inside opacity-90 font-medium">
                <li>法國罷工通常會提前 24-48 小時公佈。</li>
                <li>餐廳通常需要「預約 (Réservation)」。</li>
                <li>遇到「問路」或「填問卷」的人，請加速離開。</li>
                <li>水龍頭水可直接飲用，但建議帶保溫瓶。</li>
              </ul>
            </div>
          </div>
        )}
      </div>

      <GeminiChat />

      {/* Bottom Nav */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-8 py-5 flex justify-around items-center z-40 max-w-md mx-auto shadow-[0_-8px_30px_rgba(0,0,0,0.04)]">
        <button onClick={() => setActiveTab('plan')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'plan' ? 'text-custom-blue' : 'text-stone-300'}`}>
          <Map className={`w-6 h-6 ${activeTab === 'plan' ? 'fill-custom-blue text-custom-blue' : ''}`} />
          <span className="text-[10px] font-bold">每日行程</span>
        </button>
        <button onClick={() => setActiveTab('wishlist')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'wishlist' ? 'text-custom-blue' : 'text-stone-300'}`}>
          <Star className={`w-6 h-6 ${activeTab === 'wishlist' ? 'fill-custom-blue text-custom-blue' : ''}`} />
          <span className="text-[10px] font-bold">願望清單</span>
        </button>
        <button onClick={() => setActiveTab('guide')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'guide' ? 'text-custom-blue' : 'text-stone-300'}`}>
          <Compass className={`w-6 h-6 ${activeTab === 'guide' ? 'fill-custom-blue text-custom-blue' : ''}`} />
          <span className="text-[10px] font-bold">旅遊攻略</span>
        </button>
      </nav>
    </div>
  );
};

export default App;